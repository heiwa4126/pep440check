name: Build and Publish to TestPyPI

on:
  push:
    tags:
      # Test release tags for TestPyPI validation
      - test-*

concurrency:
  group: publish-testpypi-${{ github.ref }}
  cancel-in-progress: true

jobs:
  publish-testpypi:
    # 再利用可能なワークフローは現在、PyPIのTrusted Publishing機能ではサポートされていない。
    # https://docs.pypi.org/trusted-publishers/troubleshooting/#reusable-workflows-on-github
    # そのうえ actions でも変な docker イメージを読もうとするので、
    # こういう書き方しかできない。(2026-02)時々確認すること
    name: Publish to TestPyPI
    if: github.repository_owner == github.actor
    environment: testpypi
    runs-on: ubuntu-latest
    permissions:
      id-token: write # IMPORTANT: this permission is mandatory for Trusted Publishing
      contents: read

    steps:
      - name: Build and publish package to TestPyPI
        uses: heiwa4126/reusable-workflows/build-uv-package@663ddef519c0033f16364f061210aaf4547515d2 # v0.0.7
        with:
          checkout: true

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@ed0c53931b1dc9bd32cbe73a98c7f6766f8a527e # v1.13.0
        with:
          repository-url: https://test.pypi.org/legacy/
          # attestations: true  # PEP740 attestations (enabled by default)
